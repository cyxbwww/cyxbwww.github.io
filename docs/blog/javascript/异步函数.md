# 异步函数

异步函数，也称为“async/await”（语法关键字），是 ES6 期约模式在 ECMAScript 函数中的应用。async/await 是 ES8 规范新增的，以同步方式写的代码能够异步执行。

## 1. 异步函数

### 1.1 `async`

`async` 关键字用于声明异步函数。可以用在函数声明、函数表达式、箭头函数和方法上：

``` javascript
async function foo() {}
 
const bar = async function() {};
 
const baz = async () => {};
 
class Qux {
  async qux() {}
}
```

使用 `async` 关键字可以让函数具有异步特征，但代码仍然是同步求值的，在参数或闭包方面异步函数仍然具有普通 JavaScript 函数的正常行为，比如下面例子 `foo()` 函数仍然会在后面的指令之前被求值：

``` javascript
async function foo() {
  console.log(1);
}
 
foo();
console.log(2);
 
// 1
// 2
```

不过如果异步函数使用 `return` 关键字返回了值（没有 `return` 则会返回 `undefined`），这个值会被 `Promise.resolve()` 包装成一个期约对象。异步函数始终返回期约对象。在函数外部调用这个函数可以得到它返回的期约：

``` javascript
async function foo() {
  console.log(1);
  return 3;
 
  // 直接返回一个期约对象也一样
  // return Promise.resolve(3)
}
 
// 给返回的期约添加一个解决处理程序
foo().then(console.log);
 
console.log(2);
 
// 1
// 2
// 3
```

异步函数的返回值期待（实际上不要求）一个实现 `thenable` 接口的对象，但常规的值也可以。如果返回的是实现 `thenable` 接口的对象，则这个对象可以由提供给 `then()` 的处理程序“解包”。如果不是则返回值就被当作已经解决的期约。

``` javascript
// 返回一个原始值
async function foo() {
  return 'foo';
}
 
// foo
foo().then(console.log);
 
// 返回一个没有实现 thenable 接口的对象
async function bar() {
  return ['bar'];
}
 
// ['bar']
bar().then(console.log);
 
// 返回一个实现了 thenable 接口的非期约对象
async function baz() {
  return {
    then(callback) {
      callback('baz')
    }
  };
}
 
// baz
baz().then(console.log);
 
// 返回一个期约
async function qux() {
  return Promise.resolve('qux');
}
 
// qux
qux().then(console.log);
```

